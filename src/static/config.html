<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置设置</title>
    <!-- Load Tailwind CSS from CDN to ensure utility classes are available -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(10px); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        .animate-fade-out {
            animation: fadeOut 0.3s ease-in-out;
        }
        .toast {
            animation: fadeIn 0.3s, fadeOut 0.3s 2.7s;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        /* 移动端优化 */
        @media (max-width: 768px) {
            .container {
                padding: 1rem !important;
                max-width: 100% !important;
            }
            
            .grid {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            .bg-white {
                padding: 1rem !important;
                border-radius: 0.75rem !important;
            }
            
            h1 {
                font-size: 1.5rem !important;
                text-align: center !important;
            }
            
            h3 {
                font-size: 1.125rem !important;
            }
            
            .header {
                flex-direction: column !important;
                gap: 1rem !important;
                text-align: center !important;
            }
            
            input, textarea, select {
                font-size: 16px !important; /* 防止iOS缩放 */
                padding: 0.75rem !important;
            }
            
            button {
                min-height: 44px !important;
                padding: 0.75rem 1rem !important;
                font-size: 0.875rem !important;
            }
            
            .space-y-4 > * + * {
                margin-top: 1rem !important;
            }
            
            .grid-cols-1 {
                gap: 1rem !important;
            }
            
            .md\\:grid-cols-2 {
                grid-template-columns: 1fr !important;
            }
        }
        
        /* 超小屏幕优化 */
        @media (max-width: 480px) {
            .container {
                padding: 0.75rem !important;
            }
            
            .bg-white {
                padding: 0.75rem !important;
            }
            
            h1 {
                font-size: 1.25rem !important;
            }
            
            input, textarea {
                padding: 0.625rem !important;
            }
            
            button {
                padding: 0.625rem 0.75rem !important;
                font-size: 0.8rem !important;
            }
        }
        
        /* 确保触摸友好 */
        @media (max-width: 768px) {
            button, 
            input[type="button"], 
            input[type="submit"],
            a.btn {
                min-height: 44px !important;
                min-width: 44px !important;
            }
            
            input[type="checkbox"] {
                min-height: 20px !important;
                min-width: 20px !important;
                transform: scale(1.2) !important;
            }
            
            label {
                font-size: 0.875rem !important;
                line-height: 1.4 !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
<div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
    <div id="config-section" class="animate-fade-in">
        <header class="flex items-center justify-between mb-8">
            <h1 class="text-3xl font-bold text-gray-900">系统配置</h1>
            <button onclick="goBack()" class="text-sm font-medium text-indigo-600 hover:text-indigo-500 transition-colors">
                返回
            </button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-xl shadow-md space-y-4">
                <h3 class="text-xl font-semibold text-gray-900 border-b pb-3">AI 设置</h3>
                <div>
                    <label for="ai_api_url" class="block text-sm font-medium text-gray-700">AI API 地址</label>
                    <input type="text" id="ai_api_url" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="ai_api_key" class="block text-sm font-medium text-gray-700">AI API 密钥</label>
                    <input type="text" id="ai_api_key" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="ai_model" class="block text-sm font-medium text-gray-700">AI 模型</label>
                    <input type="text" id="ai_model" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="ai_prompt_template" class="block text-sm font-medium text-gray-700">AI 提示词模板</label>
                    <textarea id="ai_prompt_template" rows="15" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
                <div>
                    <label for="ai_summary_prompt" class="block text-sm font-medium text-gray-700">AI 每日总结提示词</label>
                    <textarea id="ai_summary_prompt" rows="10" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-md space-y-4">
                <h3 class="text-xl font-semibold text-gray-900 border-b pb-3">Telegram 设置</h3>
                <div>
                    <label for="telegram_bot_token" class="block text-sm font-medium text-gray-700">Telegram Bot Token</label>
                    <input type="text" id="telegram_bot_token" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="telegram_chat_id" class="block text-sm font-medium text-gray-700">Telegram Chat ID</label>
                    <input type="text" id="telegram_chat_id" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="flex items-center pt-2">
                    <input type="checkbox" id="telegram_enabled" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    <label for="telegram_enabled" class="ml-2 block text-sm text-gray-900">启用 Telegram 推送</label>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-md space-y-4">
                <h3 class="text-xl font-semibold text-gray-900 border-b pb-3">MCP 记忆管理</h3>
                <div class="text-sm text-gray-600 mb-4">
                    <p>Model Context Protocol (MCP) 让AI能够访问外部工具和数据源，管理用户记忆和个性化分析。</p>
                </div>
                <div class="flex items-center justify-between p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg border border-indigo-100">
                    <div>
                        <h4 class="font-medium text-gray-900">MCP 管理中心</h4>
                        <p class="text-sm text-gray-600">服务器配置、AI记忆管理和执行日志</p>
                    </div>
                    <a href="/mcp.html" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-md transition shadow-sm">
                        进入管理
                    </a>
                </div>
            </div>
        </div>

        <!-- Notion集成配置 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mt-8">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Notion 日记同步</h3>
                <div class="flex items-center space-x-2">
                    <span id="notion-status" class="text-sm text-gray-500">未配置</span>
                    <div class="w-2 h-2 bg-gray-400 rounded-full" id="notion-indicator"></div>
                </div>
            </div>
            
            <div class="space-y-4">
                <!-- Token输入 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Notion Integration Token
                        <a href="https://www.notion.com/my-integrations" target="_blank" 
                           class="ml-2 text-blue-600 hover:text-blue-800 text-xs">获取Token →</a>
                    </label>
                    <input type="password" id="notion_api_token" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                           placeholder="输入你的Notion Integration Token">
                </div>
                
                <!-- 启用开关 -->
                <div class="flex items-center justify-between">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">启用Notion同步</label>
                        <p class="text-xs text-gray-500">启用后会自动同步每日总结到Notion</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="notion_enabled" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                
                <!-- 一键配置按钮 -->
                <div class="flex space-x-3">
                    <button onclick="autoSetupNotion()" 
                            class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors"
                            id="setup-btn">
                        <span class="flex items-center justify-center">
                            <svg class="w-4 h-4 mr-2 hidden animate-spin" id="setup-spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            自动配置 Notion
                        </span>
                    </button>
                    <button onclick="testNotionConnection()" 
                            class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
                            id="test-btn">测试连接</button>
                </div>
                
                <!-- 配置状态显示 -->
                <div class="bg-gray-50 rounded-md p-3 hidden" id="notion-setup-result">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg class="w-5 h-5 text-green-500" id="success-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                            <svg class="w-5 h-5 text-red-500 hidden" id="error-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h4 class="text-sm font-medium text-gray-900" id="result-title">配置完成</h4>
                            <p class="text-sm text-gray-600 mt-1" id="result-message">
                                已自动创建"日记"页面和数据库，可以开始同步了！
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-md mt-8">
            <h3 class="text-xl font-semibold text-gray-900 border-b pb-3 mb-4">密码管理</h3>
            <form id="password-change-form" onsubmit="changePassword(event)">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="current_password" class="block text-sm font-medium text-gray-700">当前密码</label>
                        <input type="password" id="current_password" name="current_password" autocomplete="current-password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="new_password" class="block text-sm font-medium text-gray-700">新密码 (1-4位数字)</label>
                        <input type="password" id="new_password" name="new_password" maxlength="4" pattern="[0-9]{1,4}" autocomplete="new-password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                </div>
                <button type="submit" class="mt-4 px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition">
                    修改密码
                </button>
            </form>
        </div>

        <footer class="mt-8 flex items-center justify-end space-x-3">
            <button onclick="testAI()" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">测试 AI</button>
            <button onclick="testTelegram()" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">测试 Telegram</button>
            <button onclick="saveConfig()" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">保存配置</button>
        </footer>
    </div>
    <div id="toast-container" class="fixed bottom-5 right-5 space-y-2"></div>
</div>
<script>
function showToast(message, isSuccess = true) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast p-4 rounded-lg shadow-lg text-white ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

async function loadConfig() {
    try {
        const res = await fetch('/api/configs', {
            credentials: 'include'
        });
        if (!res.ok) throw new Error(`无法加载配置: ${res.statusText}`);
        const data = await res.json();
        if (data.success) {
            const map = {};
            data.configs.forEach(c => map[c.key] = c.value);
            document.getElementById('ai_api_url').value = map['ai_api_url'] || '';
            document.getElementById('ai_api_key').value = map['ai_api_key'] || '';
            document.getElementById('ai_model').value = map['ai_model'] || '';
            document.getElementById('ai_prompt_template').value = map['ai_prompt_template'] || '';
            document.getElementById('ai_summary_prompt').value = map['ai_summary_prompt'] || '';
            document.getElementById('telegram_bot_token').value = map['telegram_bot_token'] || '';
            document.getElementById('telegram_chat_id').value = map['telegram_chat_id'] || '';
            document.getElementById('telegram_enabled').checked = map['telegram_enabled'] === 'true';
            document.getElementById('notion_api_token').value = map['notion_api_token'] || '';
            document.getElementById('notion_enabled').checked = map['notion_enabled'] === 'true';
            
            // 加载Notion配置状态
            loadNotionStatus();
        } else {
            throw new Error(data.message || '加载配置失败');
        }
    } catch (error) {
        showToast(error.message, false);
    }
}

const loadingIcon = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
  </svg>`;

async function saveConfig() {
    const button = event.target;
    const originalContent = button.innerHTML;
    button.disabled = true;
    button.innerHTML = `${loadingIcon} 正在保存...`;

    try {
        const configs = [
            { key: 'ai_api_url', value: document.getElementById('ai_api_url').value },
            { key: 'ai_api_key', value: document.getElementById('ai_api_key').value },
            { key: 'ai_model', value: document.getElementById('ai_model').value },
            { key: 'ai_prompt_template', value: document.getElementById('ai_prompt_template').value },
            { key: 'ai_summary_prompt', value: document.getElementById('ai_summary_prompt').value },
            { key: 'telegram_bot_token', value: document.getElementById('telegram_bot_token').value },
            { key: 'telegram_chat_id', value: document.getElementById('telegram_chat_id').value },
            { key: 'telegram_enabled', value: document.getElementById('telegram_enabled').checked ? 'true' : 'false' },
            { key: 'notion_api_token', value: document.getElementById('notion_api_token').value },
            { key: 'notion_enabled', value: document.getElementById('notion_enabled').checked ? 'true' : 'false' }
        ];
        const res = await fetch('/api/configs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(configs),
            credentials: 'include'
        });
        const data = await res.json();
        if (data.success) {
            showToast('配置已成功保存！');
        } else {
            showToast(`保存失败: ${data.message}`, false);
        }
    } catch (error) {
        showToast(`发生错误: ${error.message}`, false);
    } finally {
        button.disabled = false;
        button.innerHTML = originalContent;
    }
}

async function changePassword(event) {
    event.preventDefault();
    
    const currentPassword = document.getElementById('current_password').value;
    const newPassword = document.getElementById('new_password').value;
    
    if (!currentPassword || !newPassword) {
        showToast('请填写当前密码和新密码', false);
        return;
    }
    
    if (!/^[0-9]{1,4}$/.test(newPassword)) {
        showToast('新密码必须是1-4位数字', false);
        return;
    }

    try {
        const res = await fetch('/api/auth/change-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                current_password: currentPassword,
                new_password: newPassword 
            }),
            credentials: 'include'
        });
        const data = await res.json();
        if (data.success) {
            showToast('密码修改成功！');
            document.getElementById('password-change-form').reset();
        } else {
            showToast(`密码修改失败: ${data.message}`, false);
        }
    } catch (error) {
        showToast(`发生错误: ${error.message}`, false);
    }
}

async function testAI() {
    const button = event.target;
    const originalContent = button.innerHTML;
    button.disabled = true;
    button.innerHTML = `${loadingIcon.replace('text-white', 'text-gray-700')} 正在测试...`;
    showToast('正在测试 AI 连接...');

    try {
        const res = await fetch('/api/admin/test-ai', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: '连接测试' }),
            credentials: 'include'
        });
        const data = await res.json();
        if (res.ok && data.success) {
            showToast(`AI 测试成功: ${data.message || data.result}`);
        } else {
            showToast(`AI 测试失败: ${data.message || '未知错误'}`, false);
        }
    } catch (error) {
        showToast(`发生错误: ${error.message}`, false);
    } finally {
        button.disabled = false;
        button.innerHTML = originalContent;
    }
}

async function testTelegram() {
    const button = event.target;
    const originalContent = button.innerHTML;
    button.disabled = true;
    button.innerHTML = `${loadingIcon.replace('text-white', 'text-gray-700')} 正在测试...`;
    showToast('正在测试 Telegram 连接...');

    try {
        const res = await fetch('/api/admin/test-telegram', { method: 'POST', credentials: 'include' });
        const data = await res.json();
        if (res.ok && data.success) {
            showToast(`Telegram 测试成功: ${data.message}`);
        } else {
            showToast(`Telegram 测试失败: ${data.message || '未知错误'}`, false);
        }
    } catch (error) {
        showToast(`发生错误: ${error.message}`, false);
    } finally {
        button.disabled = false;
        button.innerHTML = originalContent;
    }
}

// Notion相关功能
async function loadNotionStatus() {
    try {
        const response = await fetch('/api/notion/setup-status', {
            credentials: 'include'
        });
        const result = await response.json();
        
        if (result.success) {
            if (result.configured) {
                updateNotionStatus('已配置', 'green');
                if (result.page_title) {
                    showSetupResult(true, '配置完成', 
                        `已连接到页面"${result.page_title}"，Notion同步功能正常。`);
                }
            } else {
                updateNotionStatus('未配置', 'gray');
            }
        }
    } catch (error) {
        console.error('加载Notion状态失败:', error);
    }
}

async function autoSetupNotion() {
    const token = document.getElementById('notion_api_token').value.trim();
    if (!token) {
        showToast('请输入 Notion Token', false);
        return;
    }
    
    const setupBtn = document.getElementById('setup-btn');
    const spinner = document.getElementById('setup-spinner');
    
    // 显示加载状态
    setupBtn.disabled = true;
    spinner.classList.remove('hidden');
    
    try {
        const response = await fetch('/api/notion/auto-setup', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'include',
            body: JSON.stringify({ token: token })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSetupResult(true, '自动配置成功！', 
                `已创建页面"${result.page_title}"和数据库，可以开始同步日记了。`);
            updateNotionStatus('已配置', 'green');
            
            // 自动启用同步
            document.getElementById('notion_enabled').checked = true;
            showToast('Notion集成配置成功！', true);
        } else {
            showSetupResult(false, '配置失败', result.message);
        }
    } catch (error) {
        showSetupResult(false, '配置失败', '网络错误，请重试');
    } finally {
        setupBtn.disabled = false;
        spinner.classList.add('hidden');
    }
}

async function testNotionConnection() {
    try {
        const response = await fetch('/api/notion/test', {
            credentials: 'include'
        });
        const result = await response.json();
        
        if (result.success) {
            showToast(result.message, true);
            updateNotionStatus('连接正常', 'green');
        } else {
            showToast(result.message, false);
            updateNotionStatus('连接失败', 'red');
        }
    } catch (error) {
        showToast('测试连接失败: ' + error.message, false);
        updateNotionStatus('连接失败', 'red');
    }
}

function showSetupResult(success, title, message) {
    const resultDiv = document.getElementById('notion-setup-result');
    const successIcon = document.getElementById('success-icon');
    const errorIcon = document.getElementById('error-icon');
    const titleEl = document.getElementById('result-title');
    const messageEl = document.getElementById('result-message');
    
    resultDiv.classList.remove('hidden');
    successIcon.classList.toggle('hidden', !success);
    errorIcon.classList.toggle('hidden', success);
    titleEl.textContent = title;
    messageEl.textContent = message;
}

function updateNotionStatus(status, color) {
    const statusEl = document.getElementById('notion-status');
    const indicator = document.getElementById('notion-indicator');
    
    statusEl.textContent = status;
    
    // 重置所有可能的颜色类
    indicator.className = 'w-2 h-2 rounded-full';
    
    // 添加对应的颜色类
    if (color === 'green') {
        indicator.classList.add('bg-green-500');
    } else if (color === 'red') {
        indicator.classList.add('bg-red-500');
    } else {
        indicator.classList.add('bg-gray-400');
    }
}

function goBack(){
    if (window.parent && window.parent.closeSettings) {
        window.parent.closeSettings();
    } else {
        window.location.href = '/';
    }
}

// 页面加载时直接加载配置，不需要登录验证
loadConfig();
</script>
</body>
</html>
