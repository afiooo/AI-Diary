<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP 配置 - AI日记</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .modal {
            display: none;
        }
        .modal.show {
            display: flex;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* 移动端优化 */
        @media (max-width: 640px) {
            .container {
                padding: 0.5rem;
            }
            
            .grid-cols-1 {
                grid-template-columns: 1fr;
            }
            
            .text-3xl {
                font-size: 1.5rem;
            }
            
            .gap-4 {
                gap: 0.5rem;
            }
            
            .px-4 {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }
            
            .py-2 {
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- 头部 -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">MCP 配置</h1>
                <p class="text-gray-600 mt-2">管理 Model Context Protocol 服务器</p>
            </div>
            <div class="flex gap-4">
                <button onclick="showCreateModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                    添加服务器
                </button>
                <a href="/" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                    返回主页
                </a>
            </div>
        </div>

        <!-- 服务器列表 -->
        <div class="bg-white rounded-lg shadow-md">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900">MCP 服务器</h2>
            </div>
            <div id="servers-list" class="p-6">
                <!-- 服务器列表将在这里动态加载 -->
                <div class="text-center text-gray-500 py-8">
                    <p>正在加载服务器列表...</p>
                </div>
            </div>
        </div>

        <!-- 内置服务器模板 -->
        <div class="bg-white rounded-lg shadow-md mt-8">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900">内置服务器模板</h2>
                <p class="text-gray-600 mt-1">快速添加常用的MCP服务器</p>
            </div>
            <div id="builtin-servers" class="p-6">
                <!-- 内置服务器模板 -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h3 class="font-semibold text-gray-900">时间服务器</h3>
                        <p class="text-sm text-gray-600 mt-1">提供时间查询和时区转换功能</p>
                        <button onclick="addBuiltinServer('time')" class="mt-3 bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                            添加
                        </button>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h3 class="font-semibold text-gray-900">位置服务器</h3>
                        <p class="text-sm text-gray-600 mt-1">获取用户位置信息</p>
                        <button onclick="addBuiltinServer('location')" class="mt-3 bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                            添加
                        </button>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h3 class="font-semibold text-gray-900">天气服务器</h3>
                        <p class="text-sm text-gray-600 mt-1">获取天气信息和预报</p>
                        <button onclick="addBuiltinServer('weather')" class="mt-3 bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                            添加
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 用户自定义配置说明 -->
        <div class="bg-white rounded-lg shadow-md mt-8">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900">自定义配置格式</h2>
                <p class="text-gray-600 mt-1">支持标准的MCP服务器配置格式</p>
            </div>
            <div class="p-6">
                <div class="bg-gray-100 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-900 mb-2">配置示例：</h3>
                    <pre class="text-sm text-gray-700 overflow-x-auto"><code>{
  "mcpServers": {
    "time": {
      "command": "uvx",
      "args": [
        "mcp-server-time",
        "--local-timezone=America/New_York"
      ]
    }
  }
}</code></pre>
                    <p class="text-sm text-gray-600 mt-2">
                        您可以在添加服务器时使用此格式，系统会自动解析命令和参数。
                    </p>
                </div>
            </div>
        </div>

        <!-- 执行历史 -->
        <div class="bg-white rounded-lg shadow-md mt-8">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900">执行历史</h2>
            </div>
            <div id="executions-list" class="p-6">
                <!-- 执行历史将在这里动态加载 -->
                <div class="text-center text-gray-500 py-8">
                    <p>暂无执行历史</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 创建/编辑服务器模态框 -->
    <div id="server-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <h3 id="modal-title" class="text-lg font-semibold text-gray-900">添加 MCP 服务器</h3>
            </div>
            <form id="server-form" class="p-6">
                <div class="grid grid-cols-1 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">服务器名称</label>
                        <input type="text" id="server-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">描述</label>
                        <textarea id="server-description" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">配置方式</label>
                        <select id="config-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="toggleConfigType()">
                            <option value="manual">手动配置</option>
                            <option value="json">JSON配置</option>
                        </select>
                    </div>
                    
                    <!-- 手动配置 -->
                    <div id="manual-config" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">启动命令</label>
                            <input type="text" id="server-command" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="例如: uvx">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">命令参数 (JSON数组格式)</label>
                            <textarea id="server-args" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" placeholder='["mcp-server-time", "--local-timezone=America/New_York"]'></textarea>
                        </div>
                    </div>
                    
                    <!-- JSON配置 -->
                    <div id="json-config" class="space-y-4" style="display: none;">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">MCP服务器配置 (JSON格式)</label>
                            <textarea id="server-json-config" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="8" placeholder='{"mcpServers": {"time": {"command": "uvx", "args": ["mcp-server-time", "--local-timezone=America/New_York"]}}}'></textarea>
                            <p class="text-sm text-gray-600 mt-1">请输入标准的MCP服务器配置JSON</p>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">环境变量 (JSON格式，可选)</label>
                        <textarea id="server-env" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" placeholder='{"API_KEY": "your-api-key"}'></textarea>
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" id="server-enabled" class="mr-2" checked>
                        <label for="server-enabled" class="text-sm text-gray-700">启用服务器</label>
                    </div>
                </div>
                
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" onclick="hideModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
                        取消
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        保存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentServerId = null;

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadServers();
            loadExecutions();
        });

        // 切换配置类型
        function toggleConfigType() {
            const configType = document.getElementById('config-type').value;
            const manualConfig = document.getElementById('manual-config');
            const jsonConfig = document.getElementById('json-config');
            
            if (configType === 'json') {
                manualConfig.style.display = 'none';
                jsonConfig.style.display = 'block';
            } else {
                manualConfig.style.display = 'block';
                jsonConfig.style.display = 'none';
            }
        }

        // 显示创建模态框
        function showCreateModal() {
            currentServerId = null;
            document.getElementById('modal-title').textContent = '添加 MCP 服务器';
            document.getElementById('server-form').reset();
            document.getElementById('server-enabled').checked = true;
            toggleConfigType();
            document.getElementById('server-modal').classList.add('show');
        }

        // 隐藏模态框
        function hideModal() {
            document.getElementById('server-modal').classList.remove('show');
        }

        // 添加内置服务器
        function addBuiltinServer(type) {
            const configs = {
                'time': {
                    name: '时间服务器',
                    description: '提供时间查询和时区转换功能',
                    command: 'uvx',
                    args: '["mcp-server-time", "--local-timezone=Asia/Shanghai"]'
                },
                'location': {
                    name: '位置服务器',
                    description: '获取用户位置信息',
                    command: 'uvx',
                    args: '["mcp-server-location"]'
                },
                'weather': {
                    name: '天气服务器',
                    description: '获取天气信息和预报',
                    command: 'uvx',
                    args: '["mcp-server-weather"]'
                }
            };
            
            const config = configs[type];
            if (config) {
                document.getElementById('server-name').value = config.name;
                document.getElementById('server-description').value = config.description;
                document.getElementById('server-command').value = config.command;
                document.getElementById('server-args').value = config.args;
                document.getElementById('config-type').value = 'manual';
                toggleConfigType();
                showCreateModal();
            }
        }

        // 加载服务器列表
        async function loadServers() {
            try {
                const response = await fetch('/api/mcp/servers');
                if (response.ok) {
                    const data = await response.json();
                    displayServers(data.servers || []);
                } else {
                    document.getElementById('servers-list').innerHTML = '<div class="text-center text-red-500 py-8"><p>加载服务器列表失败</p></div>';
                }
            } catch (error) {
                console.error('加载服务器列表失败:', error);
                document.getElementById('servers-list').innerHTML = '<div class="text-center text-red-500 py-8"><p>加载服务器列表失败</p></div>';
            }
        }

        // 显示服务器列表
        function displayServers(servers) {
            const container = document.getElementById('servers-list');
            
            if (servers.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8"><p>暂无MCP服务器</p></div>';
                return;
            }
            
            const html = servers.map(server => `
                <div class="border border-gray-200 rounded-lg p-4 mb-4">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-900">${server.name}</h3>
                            <p class="text-sm text-gray-600 mt-1">${server.description || '无描述'}</p>
                            <div class="mt-2 text-xs text-gray-500">
                                <span class="inline-block mr-4">命令: ${server.command || '未配置'}</span>
                                <span class="inline-block mr-4">状态: ${server.enabled ? '启用' : '禁用'}</span>
                                <span class="inline-block">最后连接: ${server.last_connected ? new Date(server.last_connected).toLocaleString() : '从未连接'}</span>
                            </div>
                        </div>
                        <div class="flex gap-2 ml-4">
                            <button onclick="startServer(${server.id})" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                启动
                            </button>
                            <button onclick="stopServer(${server.id})" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                                停止
                            </button>
                            <button onclick="editServer(${server.id})" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                编辑
                            </button>
                            <button onclick="deleteServer(${server.id})" class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700">
                                删除
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        // 启动服务器
        async function startServer(serverId) {
            try {
                const response = await fetch(`/api/mcp/servers/${serverId}/start`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('服务器启动成功');
                    loadServers();
                } else {
                    alert('启动失败：' + data.message);
                }
            } catch (error) {
                alert('启动失败：' + error.message);
            }
        }

        // 停止服务器
        async function stopServer(serverId) {
            try {
                const response = await fetch(`/api/mcp/servers/${serverId}/stop`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('服务器已停止');
                    loadServers();
                } else {
                    alert('停止失败：' + data.message);
                }
            } catch (error) {
                alert('停止失败：' + error.message);
            }
        }

        // 删除服务器
        async function deleteServer(serverId) {
            if (!confirm('确定要删除这个服务器吗？')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/mcp/servers/${serverId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('服务器已删除');
                    loadServers();
                } else {
                    alert('删除失败：' + data.message);
                }
            } catch (error) {
                alert('删除失败：' + error.message);
            }
        }

        // 编辑服务器
        function editServer(serverId) {
            // 这里可以实现编辑功能
            alert('编辑功能待实现');
        }

        // 加载执行历史
        async function loadExecutions() {
            try {
                const response = await fetch('/api/mcp/executions');
                if (response.ok) {
                    const data = await response.json();
                    displayExecutions(data.executions || []);
                }
            } catch (error) {
                console.error('加载执行历史失败:', error);
            }
        }

        // 显示执行历史
        function displayExecutions(executions) {
            const container = document.getElementById('executions-list');
            
            if (executions.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8"><p>暂无执行历史</p></div>';
                return;
            }
            
            const html = executions.slice(0, 10).map(exec => `
                <div class="border-b border-gray-200 py-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="font-medium">${exec.target_name}</span>
                            <span class="text-sm text-gray-500 ml-2">${exec.execution_type}</span>
                        </div>
                        <div class="text-right">
                            <span class="text-sm ${exec.status === 'success' ? 'text-green-600' : 'text-red-600'}">${exec.status}</span>
                            <div class="text-xs text-gray-500">${new Date(exec.created_at).toLocaleString()}</div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        // 表单提交
        document.getElementById('server-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const configType = document.getElementById('config-type').value;
            let serverData;
            
            if (configType === 'json') {
                // JSON配置模式
                const jsonConfig = document.getElementById('server-json-config').value;
                try {
                    const config = JSON.parse(jsonConfig);
                    
                    // 直接发送整个配置对象，让后端处理
                    serverData = config;
                } catch (error) {
                    alert('JSON配置格式错误：' + error.message);
                    return;
                }
            } else {
                // 手动配置模式
                serverData = {
                    name: document.getElementById('server-name').value,
                    description: document.getElementById('server-description').value,
                    command: document.getElementById('server-command').value,
                    args: document.getElementById('server-args').value || '[]',
                    env_vars: document.getElementById('server-env').value || '{}',
                    enabled: document.getElementById('server-enabled').checked,
                    transport: 'stdio'
                };
            }
            
            try {
                const url = currentServerId ? `/api/mcp/servers/${currentServerId}` : '/api/mcp/servers';
                const method = currentServerId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(serverData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(currentServerId ? '服务器更新成功' : '服务器创建成功');
                    hideModal();
                    loadServers();
                } else {
                    alert('操作失败：' + data.message);
                }
            } catch (error) {
                alert('操作失败：' + error.message);
            }
        });
    </script>
</body>
</html>

